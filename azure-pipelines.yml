name: $(major).$(minor).$(rev:r)
stages:
  - stage: build
    displayName: Build VSIX
    jobs:
      - job: Build
        pool:
          vmimage: ubuntu-latest
        steps: 
        - powershell: |
            $V9Task = Get-Content ./Extension/PesterTask/PesterV9/task.json -Raw | ConvertFrom-Json
            $V9Task.Version.Major = 9
            $V9Task.Version.Minor = $(Minor)
            $V9Task.Version.Patch = "$(Build.BuildNumber)".Split('.')[-1]
            $V9Task | ConvertTo-Json -Depth 10 | Set-Content ./Extension/PesterTask/PesterV9/task.json
          displayName: Update V9 task version

        - powershell: |
            $VLatestTask = Get-Content ./Extension/PesterTask/PesterV10/task.json -Raw | ConvertFrom-Json
            $VLatestTask.Version.Major = $(Major)
            $VLatestTask.Version.Minor = $(Minor)
            $VLatestTask.Version.Patch = "$(Build.BuildNumber)".Split('.')[-1]
            $VLatestTask | ConvertTo-Json -Depth 10 | Set-Content ./Extension/PesterTask/PesterV10/task.json
          displayName: Update V9 task version

        - task: NodeTool@0
          inputs:
            versionSpec: '10.x'
          displayName: 'Install Node.js'

        - script: |
            npm install
            npm run build
          displayName: 'npm install and build'
          workingDirectory: ./Extension

        - script: |
            npm run package
          workingDirectory: ./Extension

        - task: TfxInstaller@2
          inputs:
            version: 'v0.6.x'

        - task: PackageAzureDevOpsExtension@2
          inputs:
            rootFolder: './Extension'
            outputPath: '$(Build.ArtifactStagingDirectory)/Pester.vsix'
            updateTasksVersion: true
            extensionVersion: "$(Build.BuildNumber)"

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact: vsix'
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: vsix
